name: CoSAI Risk Map Validation

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'risk-map/yaml/**'
      - 'risk-map/schemas/**'
  push:
    branches: [main, develop]
    paths:
      - 'risk-map/yaml/**'
      - 'risk-map/schemas/**'

jobs:
  # Setup job to install dependencies and prepare validation scripts
  setup:
    runs-on: ubuntu-latest
    name: Setup Environment
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Setup Node
      uses: actions/setup-node@v5
      with:
        node-version: '22.x'
        cache: 'npm'

    - name: Copy validation scripts to working directory
      run: |
        # Copy the scripts from the repo to make them executable in CI
        cp scripts/hooks/validate_riskmap.py .
        mkdir -p riskmap_validator
        cp -r scripts/hooks/riskmap_validator/* ./riskmap_validator/
        cp scripts/hooks/validate_control_risk_references.py .

    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        npm ci

    - name: Generate cache key
      id: cache-key
      run: |
        echo "key=deps-${{ hashFiles('requirements.txt', 'package-lock.json') }}" >> $GITHUB_OUTPUT

  # Individual validation jobs that can fail independently
  schema-validation:
    runs-on: ubuntu-latest
    name: YAML Schema Validation
    needs: setup
    outputs:
      validation_status: ${{ steps.validate-schema.outputs.status }}
      validation_count: ${{ steps.validate-schema.outputs.count }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Setup Node
      uses: actions/setup-node@v5
      with:
        node-version: '22.x'
        cache: 'npm'

    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        npm ci

    - name: Run YAML Schema Validation
      id: validate-schema
      run: |
        echo "ðŸ” Running YAML schema validation..."

        BASE_URI="file://$(pwd)/risk-map/schemas/"
        YAML_BASE_DIR="risk-map/yaml"
        SCHEMA_BASE_DIR="risk-map/schemas"
        SOURCE_FILES=("controls" "components" "personas" "risks" "self-assessment" "mermaid-styles")

        validation_failed=false
        validation_count=0

        for target in "${SOURCE_FILES[@]}"; do
          schema_file="${SCHEMA_BASE_DIR}/${target}.schema.json"
          yaml_file="${YAML_BASE_DIR}/${target}.yaml"

          if [[ -f "$yaml_file" && -f "$schema_file" ]]; then
            echo "ðŸ“„ Validating ${yaml_file} against ${schema_file}..."
            validation_count=$((validation_count + 1))

            if check-jsonschema --base-uri "$BASE_URI" --schemafile "$schema_file" "$yaml_file"; then
              echo "âœ… ${yaml_file} is valid"
            else
              echo "âŒ ${yaml_file} validation failed"
              validation_failed=true
            fi
          else
            echo "âš ï¸  Skipping ${target}: missing files"
          fi
        done

        echo "count=$validation_count" >> $GITHUB_OUTPUT

        if [ "$validation_failed" = true ]; then
          echo "::error::YAML schema validation failed"
          echo "status=failed" >> $GITHUB_OUTPUT
          exit 1
        fi

        echo "âœ… All YAML schema validations passed"
        echo "status=success" >> $GITHUB_OUTPUT

  format-validation:
    runs-on: ubuntu-latest
    name: YAML Format Validation
    needs: setup
    outputs:
      format_status: ${{ steps.validate-format.outputs.status }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node
      uses: actions/setup-node@v5
      with:
        node-version: '22.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run YAML Format Validation
      id: validate-format
      run: |
        echo "ðŸŽ¨ Running YAML format validation..."

        if npx prettier --check risk-map/yaml/*.yaml; then
          echo "âœ… YAML format validation completed successfully"
          echo "status=success" >> $GITHUB_OUTPUT
        else
          echo "âŒ YAML format validation failed"
          echo "::error::YAML files are not properly formatted. Run 'npx prettier --write risk-map/yaml/*.yaml' locally."
          echo "status=failed" >> $GITHUB_OUTPUT
          exit 1
        fi

  component-edge-validation:
    runs-on: ubuntu-latest
    name: Component Edge Validation
    needs: setup
    outputs:
      edge_status: ${{ steps.validate-edges.outputs.status }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Copy validation scripts
      run: |
        cp scripts/hooks/validate_riskmap.py .
        mkdir -p riskmap_validator
        cp -r scripts/hooks/riskmap_validator/* ./riskmap_validator/

    - name: Install dependencies
      run: pip install -r requirements.txt

    - name: Run Component Edge Validation
      id: validate-edges
      run: |
        echo "ðŸ”— Running component edge validation..."

        if python3 validate_riskmap.py --force; then
          echo "âœ… Component edge validation completed successfully"
          echo "status=success" >> $GITHUB_OUTPUT
        else
          echo "âŒ Component edge validation failed"
          echo "::error::Component edge validation failed"
          echo "status=failed" >> $GITHUB_OUTPUT
          exit 1
        fi

  control-risk-validation:
    runs-on: ubuntu-latest
    name: Control-Risk Reference Validation
    needs: setup
    outputs:
      control_status: ${{ steps.validate-controls.outputs.status }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Copy validation scripts
      run: cp scripts/hooks/validate_control_risk_references.py .

    - name: Install dependencies
      run: pip install -r requirements.txt

    - name: Run Control-Risk Reference Validation
      id: validate-controls
      run: |
        echo "ðŸ”’ Running control-to-risk reference validation..."

        if python3 validate_control_risk_references.py --force; then
          echo "âœ… Control-to-risk reference validation completed successfully"
          echo "status=success" >> $GITHUB_OUTPUT
        else
          echo "âŒ Control-to-risk reference validation failed"
          echo "::error::Control-to-risk reference validation failed"
          echo "status=failed" >> $GITHUB_OUTPUT
          exit 1
        fi

  graph-validation:
    runs-on: ubuntu-latest
    name: Graph Validation
    needs: setup
    outputs:
      graph_status: ${{ steps.validate-graphs.outputs.status }}
      graphs_validated: ${{ steps.validate-graphs.outputs.graphs_validated }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Copy validation scripts
      run: |
        cp scripts/hooks/validate_riskmap.py .
        mkdir -p riskmap_validator
        cp -r scripts/hooks/riskmap_validator/* ./riskmap_validator/

    - name: Install dependencies
      run: pip install -r requirements.txt

    - name: Validate graphs
      id: validate-graphs
      run: |
        # Setup temporary files and paths
        RISK_MAP_TEMP_FILE=$(mktemp)
        CONTROLS_TEMP_FILE=$(mktemp)
        RISK_CONTROLS_TEMP_FILE=$(mktemp)
        RISKMAP_PATH="./risk-map/diagrams/risk-map-graph.md"
        CONTROL_GRAPH_PATH="./risk-map/diagrams/controls-graph.md"
        RISK_CONTROLS_PATH="./risk-map/diagrams/controls-to-risk-graph.md"
        VALIDATE_CMD="validate_riskmap.py"

        # Define graph configurations as arrays
        GRAPH_NAMES=("Component Graph" "Control Graph" "Controls-to-Risk Graph")
        TEMP_FILES=("${RISK_MAP_TEMP_FILE}" "${CONTROLS_TEMP_FILE}" "${RISK_CONTROLS_TEMP_FILE}")
        TARGET_PATHS=("${RISKMAP_PATH}" "${CONTROL_GRAPH_PATH}" "${RISK_CONTROLS_PATH}")
        GENERATE_ARGS=("--to-graph" "--to-controls-graph" "--to-risk-graph")

        graph_compare_failed=false
        graphs_validated=0

        # Loop through all graph types
        for i in "${!GRAPH_NAMES[@]}"; do
            graph_name="${GRAPH_NAMES[$i]}"
            temp_file="${TEMP_FILES[$i]}"
            target_path="${TARGET_PATHS[$i]}"
            gen_args="${GENERATE_ARGS[$i]}"

            echo "ðŸ” Validating ${graph_name}..."
            graphs_validated=$((graphs_validated + 1))

            if ! python3 ${VALIDATE_CMD} --force ${gen_args} "${temp_file}"; then
                echo "âŒ ${graph_name} generation via ${VALIDATE_CMD} failed..."
                graph_compare_failed=true
            elif ! output=$(diff -u "${target_path}" "${temp_file}" 2>&1); then
                echo "âŒ Generated ${graph_name,,} does not match PR ${graph_name,,}..."
                echo "::error title=Files differ::Differences found in ${graph_name}"
                echo "::group::${graph_name} Diff Output"
                echo "${output}"
                echo "::endgroup::"
                graph_compare_failed=true
            else
                echo "âœ… Generated ${graph_name,,} matches ${target_path}"
            fi
        done

        # Cleanup temp files
        rm -f ${RISK_MAP_TEMP_FILE}
        rm -f ${CONTROLS_TEMP_FILE}
        rm -f ${RISK_CONTROLS_TEMP_FILE}

        echo "graphs_validated=$graphs_validated" >> $GITHUB_OUTPUT

        if [ "$graph_compare_failed" = true ]; then
          echo "::error::Graph validation failed"
          echo "status=failed" >> $GITHUB_OUTPUT
          exit 1
        fi

        echo "âœ… All graph validations passed"
        echo "status=success" >> $GITHUB_OUTPUT

  # Summary job that requires all other jobs but doesn't fail
  validation-summary:
    runs-on: ubuntu-latest
    name: Validation Summary
    needs: [schema-validation, format-validation, component-edge-validation, control-risk-validation, graph-validation]
    if: always()
    steps:
    - name: Generate Summary
      run: |
        echo "# ðŸ“‹ CoSAI Risk Map Validation Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Check individual job results
        schema_result="${{ needs.schema-validation.result }}"
        format_result="${{ needs.format-validation.result }}"
        edge_result="${{ needs.component-edge-validation.result }}"
        control_result="${{ needs.control-risk-validation.result }}"
        graph_result="${{ needs.graph-validation.result }}"

        # Get output details
        validation_count="${{ needs.schema-validation.outputs.validation_count }}"
        graphs_validated="${{ needs.graph-validation.outputs.graphs_validated }}"

        overall_success=true

        echo "## Individual Job Results:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "$schema_result" = "success" ]; then
          echo "- âœ… **YAML schema validation**: Passed ($validation_count schemas)" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âŒ **YAML schema validation**: $schema_result" >> $GITHUB_STEP_SUMMARY
          overall_success=false
        fi

        if [ "$format_result" = "success" ]; then
          echo "- âœ… **YAML format validation**: Passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âŒ **YAML format validation**: $format_result" >> $GITHUB_STEP_SUMMARY
          overall_success=false
        fi

        if [ "$edge_result" = "success" ]; then
          echo "- âœ… **Component edge validation**: Passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âŒ **Component edge validation**: $edge_result" >> $GITHUB_STEP_SUMMARY
          overall_success=false
        fi

        if [ "$control_result" = "success" ]; then
          echo "- âœ… **Control-to-risk reference validation**: Passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âŒ **Control-to-risk reference validation**: $control_result" >> $GITHUB_STEP_SUMMARY
          overall_success=false
        fi

        if [ "$graph_result" = "success" ]; then
          echo "- âœ… **Graph validation**: Passed ($graphs_validated graphs)" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âŒ **Graph validation**: $graph_result" >> $GITHUB_STEP_SUMMARY
          overall_success=false
        fi

        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "$overall_success" = "true" ]; then
          echo "## âœ… Overall Status: Success" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ All validations passed!" >> $GITHUB_STEP_SUMMARY
        else
          echo "## âŒ Overall Status: Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’¥ Some validations failed. Check individual job details above." >> $GITHUB_STEP_SUMMARY
          echo "::error::Some CoSAI Risk Map validations failed"
          exit 1
        fi