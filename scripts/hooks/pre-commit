#!/bin/bash

# =============================================================================
# Git Pre-commit Hook for Risk-Map Validation
# =============================================================================
# This hook validates:
# - component edge consistency
# - control-risk cross-reference integrity
# - YAML schema compliance
# - generates SVG files from Mermaid diagrams
# - generates markdown tables from YAML files
#
# Manual Installation:
#   Save as .git/hooks/pre-commit and chmod +x .git/hooks/pre-commit
#
# Behavior:
#   - Validates only staged files by default
#   - If...
#        - riskmap.schema.json changes, validates YAML schema compliance for
#          all files
#        - components.yaml changes, generates component graph, component tables,
#          and controls-xref-components table
#        - controls.yaml changes, generates control graph and all 4 control tables
#        - risks.yaml changes, generates risk graph, risk tables, and
#          controls-xref-risks table
#        - .mmd/.mermaid files change, generates corresponding SVG files in
#          ./risk-map/svg/ and adds them to the staged files
#   - Use --force/-f to run all validations against all files regardless of
#     staging status. NOTE: --force will not generate graphs or tables
#   - See ./git/hooks/validate_riskmap.py for manual graph generation
#   - See ./git/hooks/yaml_to_markdown.py for manual table generation
#
# =============================================================================

# =============================================================================
# Configuration and Constants
# =============================================================================

# Base URI for schema resolution - must be absolute file:// path
BASE_URI="file://$(pwd)/risk-map/schemas/"

# Directory paths for YAML files and schemas
YAML_BASE_DIR="risk-map/yaml"
SCHEMA_BASE_DIR="risk-map/schemas"

# Suffix for schema files
SCHEMA_SUFFIX=".schema.json"

# List of YAML|schema files to validate without extensions
SOURCE_FILES=("controls" "components" "personas" "risks" "self-assessment" "mermaid-styles" "frameworks" "lifecycle-stage" "impact-type" "actor-access")

# Path to Chrome/Chromium for SVG generation
# Leave empty for automatic Chrome detection, or set to specific path for CI/CD
# Example: CHROMIUM_PATH="/ms-playwright/chromium_headless_shell-1187/chrome-linux/headless_shell"
CHROMIUM_PATH=""  # Empty = auto-detect

# Output directories for generated files
DIAGRAMS_DIR="risk-map/diagrams"
TABLES_DIR="risk-map/tables"
SVG_DIR="risk-map/svg"
TEMPLATE_DIR=".github/ISSUE_TEMPLATE"

# =============================================================================
# Source Utility Functions
# =============================================================================

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
HOOKS_DIR="$(cd "${SCRIPT_DIR}/../../scripts/hooks" && pwd)"

# Source git utility functions
if [[ -f "${HOOKS_DIR}/git_utils.sh" ]]; then
    source "${HOOKS_DIR}/git_utils.sh"
else
    echo "Error: git_utils.sh not found at ${HOOKS_DIR}/git_utils.sh"
    exit 1
fi

# Source validator runner utility
if [[ -f "${HOOKS_DIR}/run_validator.sh" ]]; then
    source "${HOOKS_DIR}/run_validator.sh"
else
    echo "Error: run_validator.sh not found at ${HOOKS_DIR}/run_validator.sh"
    exit 1
fi

# =============================================================================
# Global Variables and Flags
# =============================================================================

# Flag to force validation of all files (0=false, 1=true)
FORCE_VALIDATE=0

# Arguments to pass to edge/reference validators ("" or "--force")
EDGE_ARGS=""

# Variable to track if any validation failed (0=all passed, 1=some failed)
VALIDATION_FAILED=0

# =============================================================================
# Dependency Checks
# =============================================================================

# Ensure check-jsonschema is installed before proceeding
if ! command -v check-jsonschema &> /dev/null; then
    echo "Error: check-jsonschema is not installed. Install with: pip install check-jsonschema"
    exit 1
fi

# =============================================================================
# Core Schema Validation Functions
# =============================================================================

# Validates a single YAML file against its corresponding JSON schema
# Args:
#   $1 - target: filename without extension (e.g., "controls")
#   $2 - error_type: optional custom error message
check_schema() {
    local target="$1"
    local error_type="$2"

    # Construct file paths
    local schema_file="${SCHEMA_BASE_DIR}/${target}${SCHEMA_SUFFIX}"
    local yaml_file="${YAML_BASE_DIR}/${target}.yaml"

    echo "Validating $yaml_file against $schema_file..."
    
    # Run validation and capture exit code
    if ! check-jsonschema --base-uri "$BASE_URI" --schemafile "${schema_file}" "${yaml_file}" > /dev/null ; then
        # Handle validation failure
        if [[ -n "$error_type" ]]; then
            echo "$error_type"
            return 1  # Return error but don't exit (for batch validation)
        else 
            echo "‚ùå Schema validation failed for ${target}.yaml"
            return 1   # Return error but don't exit 
        fi
    fi
    
    echo "‚úÖ Schema validation passed for ${target}.yaml"
}

# Validates a YAML file only if it or its schema is staged for commit
# Args:
#   $1 - target: filename without extension
# Returns:
#   0 if validation passed or file not staged, 1 if validation failed
validate_if_staged() {
    local target=$1
    local yaml_file="${YAML_BASE_DIR}/${target}.yaml"
    local schema_file="${SCHEMA_BASE_DIR}/${target}${SCHEMA_SUFFIX}"

    # Check if either the YAML file or its schema is staged
    if git diff --cached --name-only | grep -q "${yaml_file}$\|${schema_file}$"; then
        check_schema "$target"

        return $?  # Return error if validation failed
    fi

    return 0  # No validation needed, file not staged   
}

# Validates all YAML files (used when riskmap.schema.json changes)
# This is necessary because riskmap.schema.json affects all YAML validations
# Returns:
#   0 if validation passed or file not staged, 1 if validation failed
validate_all_yaml() {
    echo "riskmap.schema.json changed - validating all YAML files..."
    local failed=0
    echo ${SOURCE_FILES[@]} 

    # Validate each existing YAML file
    for input_file in "${SOURCE_FILES[@]}"; do
        if [[ -f "${YAML_BASE_DIR}/${input_file}.yaml" ]]; then
            # Use custom error message for batch validation
            check_schema "$input_file" "‚ùå Schema validation for ${input_file}.yaml failed due to riskmap.schema.json changes"
            if [[ $? -ne 0 ]]; then
                failed=1  # Mark as failed but continue checking other files
            fi
        fi
    done

    # Exit with error if any validation failed
    if [[ $failed -ne 0 ]]; then
        return 1
    fi 

    echo "‚úÖ All YAML files still valid after riskmap schema changes"
}

# =============================================================================
# Command Line Argument Parsing
# =============================================================================

# Parse command-line arguments for help and force options
case $1 in
    --help|-h)
        echo "Usage: pre-commit hook for validating risk-map tooling"
        echo "Validates only staged files unless riskmap.schema.json is modified or -f|--force , in which case all YAML files are validated."
        echo "----"
        echo "Options:"
        echo "  --help|-h       Show this help message and exit"
        echo "  --force|-f      Force validation of all risk-map files regardless of staging status"
        echo "----"
        echo "Validations performed:"
        echo "  - YAML schema validation"
        echo "  - Prettier formatting (risk-map/yaml/ files only)"
        echo "  - Ruff linting (Python files only)"
        echo "  - Component edge validation"
        echo "  - Control-to-risk reference validation"
        echo "  - Framework reference validation"
        echo "  - Issue template validation (GitHub schemas)"
        echo "  - Mermaid SVG generation (when .mmd/.mermaid files change)"
        echo ""
        echo "Automatic generation:"
        echo "  - When components.yaml is staged, generates ./risk-map/diagrams/risk-map-graph.md"
        echo "  - When components.yaml or controls.yaml is staged, generates ./risk-map/diagrams/controls-graph.md"
        echo "  - When components.yaml, controls.yaml or risks.yaml is staged, generates ./risk-map/diagrams/controls-to-risk-graph.md"
        echo "  - When .mmd/.mermaid files are staged, generates corresponding SVG files in ./risk-map/svg/"
        echo "  - Generated files are added to staged files for inclusion in commit"
        echo "  - Automatic generation is skipped in --force"
        echo "  - Use .git/hooks/validate_riskmap.py for manual graph generation"
        exit 0
        ;;
    --force|-f)
        echo "Force validating all risk-map files..."
        FORCE_VALIDATE=1
        EDGE_ARGS="--force"  # Pass force flag to sub-validators
esac

# =============================================================================
# Main Schema Validation Logic
# =============================================================================

echo "Running YAML schema validation..."

# If riskmap.schema.json is being modified, validate all YAML files
# This is necessary because this master schema affects all other validations
if git diff --cached --name-only | grep -q "schemas/riskmap\.schema\.json$" ; then
    validate_all_yaml
    if [[ $? -ne 0 ]]; then
        VALIDATION_FAILED=1  # Mark as failed but continue checking other files
    fi
fi

# Validate individual YAML files based on what's staged or force flag
failed=0
for each in "${SOURCE_FILES[@]}"; do
    if [[ $FORCE_VALIDATE -eq 1 ]]; then
        # Force mode: validate all files regardless of staging status
        check_schema "$each"
        failed=$?
    else
        # Normal mode: only validate if file is staged
        validate_if_staged "$each"
        failed=$?
    fi
    if [[ $failed -ne 0 ]]; then
        VALIDATION_FAILED=1  # Mark as failed but continue checking other files
    fi
done



# =============================================================================
# Prettier Formatting for YAML Files
# =============================================================================

# Formats YAML files in risk-map/yaml directory using prettier
# Args: none (uses global FORCE_VALIDATE and EDGE_ARGS flags)
# Behavior:
#   - Normal mode: formats only staged YAML files in risk-map/yaml/
#   - Force mode: formats all YAML files in risk-map/yaml/
format_yaml_files() {
    echo "üé® Running prettier formatting on YAML files..."
    
    local files_to_format=()
    local formatting_failed=0
    
    if [[ $FORCE_VALIDATE -eq 1 ]]; then
        # Force mode: format all YAML files in risk-map/yaml/
        echo "   Force mode: formatting all YAML files in risk-map/yaml/"
        for file in risk-map/yaml/*.yaml; do
            if [[ -f "$file" ]]; then
                files_to_format+=("$file")
            fi
        done
    else
        # Normal mode: format only staged YAML files in risk-map/yaml/
        echo "   Normal mode: formatting staged YAML files in risk-map/yaml/"
        while IFS= read -r -d '' file; do
            # Only include files that are in risk-map/yaml/ directory
            if [[ "$file" == risk-map/yaml/*.yaml ]]; then
                files_to_format+=("$file")
            fi
        done < <(git diff --cached --name-only -z | grep -z '\.ya\?ml$')
    fi
    
    # Format files if any were found
    if [[ ${#files_to_format[@]} -gt 0 ]]; then
        echo "   Formatting ${#files_to_format[@]} YAML file(s)..."
        
        for file in "${files_to_format[@]}"; do
            echo "   Formatting $file..."
            if ! npx prettier --write "$file"; then
                echo "   ‚ùå Prettier formatting failed for $file"
                formatting_failed=1
            else
                echo "   ‚úÖ Formatted $file"
                # Add formatted file back to staging area (only in normal mode)
                if [[ $FORCE_VALIDATE -eq 0 ]]; then
                    stage_files "$file" "Formatted $(basename "$file")"
                fi
            fi
        done
        
        if [[ $formatting_failed -eq 0 ]]; then
            echo "   ‚úÖ All YAML files formatted successfully"
        fi
    else
        echo "   No YAML files in risk-map/yaml/ to format"
    fi
    
    return $formatting_failed
}

# Run prettier formatting
format_yaml_files
if [[ $? -ne 0 ]]; then
    VALIDATION_FAILED=1
fi

# =============================================================================
# Ruff Linting for Python Files
# =============================================================================

# Runs ruff linting on Python files
# Args: none (uses global FORCE_VALIDATE flag)
# Behavior:
#   - Normal mode: lints only staged Python files
#   - Force mode: lints all Python files in the repository
run_ruff_check() {
    echo "üîç Running ruff linting on Python files..."
    
    local ruff_failed=0
    local files_to_check=()
    
    if [[ $FORCE_VALIDATE -eq 1 ]]; then
        # Force mode: check all Python files
        echo "   Force mode: linting all Python files"
        if ! ruff check .; then
            echo "   ‚ùå Ruff linting failed"
            ruff_failed=1
        else
            echo "   ‚úÖ All Python files passed ruff linting"
        fi
    else
        # Normal mode: check only staged Python files
        echo "   Normal mode: linting staged Python files"
        
        # Get staged Python files
        while IFS= read -r -d '' file; do
            if [[ -f "$file" ]]; then
                files_to_check+=("$file")
            fi
        done < <(git diff --cached --name-only -z | grep -z '\.py$')
        
        if [[ ${#files_to_check[@]} -gt 0 ]]; then
            echo "   Checking ${#files_to_check[@]} Python file(s)..."
            if ! ruff check "${files_to_check[@]}"; then
                echo "   ‚ùå Ruff linting failed for staged files"
                ruff_failed=1
            else
                echo "   ‚úÖ All staged Python files passed ruff linting"
            fi
        else
            echo "   No staged Python files to check"
        fi
    fi
    
    return $ruff_failed
}

# Run ruff check
run_ruff_check
if [[ $? -ne 0 ]]; then
    VALIDATION_FAILED=1
fi

echo  # Add blank line for readability

# =============================================================================
# Component Edge Validation
# =============================================================================
echo "üîó Running component edge validation..."

# Path to the component edge validation script
EDGE_VALIDATOR=".git/hooks/validate_riskmap.py"

# Run the component edge validation with appropriate args based on passed flags
run_validator "$EDGE_VALIDATOR" "component edge validation" "$EDGE_ARGS"
if [[ $? -ne 0 ]]; then
    VALIDATION_FAILED=1
fi

# =============================================================================
# Component Graph Generation (when components.yaml changes)
# =============================================================================

# Only generate component graph in normal mode (not --force) when components.yaml is staged
if [[ $FORCE_VALIDATE -eq 0 ]] && git diff --cached --name-only | grep -q "risk-map/yaml/components\.yaml$"; then
    echo "üìä Components.yaml changed - generating component relationship graph..."

    # Ensure diagrams directory exists
    mkdir -p "${DIAGRAMS_DIR}"

    # Generate the graph using the validator script
    if python3 "$EDGE_VALIDATOR" --to-graph "${DIAGRAMS_DIR}/risk-map-graph.md" -m --quiet; then
        echo "   ‚úÖ Graph generated at ${DIAGRAMS_DIR}/risk-map-graph.md"

        # Add the generated graph files to staging area
        stage_files "${DIAGRAMS_DIR}/risk-map-graph.md ${DIAGRAMS_DIR}/risk-map-graph.mermaid" "Risk Map Graph"
    else
        echo "   ‚ùå Risk Map Graph generation failed"
        VALIDATION_FAILED=1
    fi
fi

echo  # Add blank line for readability

# =============================================================================
# Control-to-Risk Reference Validation
# =============================================================================
echo "üîó Running control-to-risk reference validation..."

# Path to the control-risk reference validation script
REF_VALIDATOR=".git/hooks/validate_control_risk_references.py"

# Run the control-risk reference validation
# Uses same EDGE_ARGS since both validators support --force flag
run_validator "$REF_VALIDATOR" "control-to-risk reference validation" "$EDGE_ARGS"
if [[ $? -ne 0 ]]; then
    VALIDATION_FAILED=1
fi

echo  # Add blank line for readability

# =============================================================================
# Framework Reference Validation
# =============================================================================
echo "üîó Running framework reference validation..."

# Path to the framework reference validation script
FRAMEWORK_VALIDATOR=".git/hooks/validate_framework_references.py"

# Run the framework reference validation
# Uses same EDGE_ARGS since both validators support --force flag
run_validator "$FRAMEWORK_VALIDATOR" "framework reference validation" "$EDGE_ARGS"
if [[ $? -ne 0 ]]; then
    VALIDATION_FAILED=1
fi

echo  # Add blank line for readability

# =============================================================================
# Generate Issue Templates
# =============================================================================
if [[ $FORCE_VALIDATE -eq 0 ]] && git diff --cached --name-only | grep -q "scripts/TEMPLATES/.*.yml$"; then

    echo "üîó Github issue template changes - regenerating issue templates..."

    ISSUE_TEMPLATE_GENERATOR="scripts/generate_issue_templates.py"

    # ensure template dir exists
    mkdir -p "${TEMPLATE_DIR}"

    python3 "$ISSUE_TEMPLATE_GENERATOR" >/dev/null
    if [[ $? -ne 0 ]]; then 
        VALIDATION_FAILED=1
        echo "   ‚ùå Github Issue Template generation failed"
    fi 

    echo "   ‚úÖ Github Issue Templates generated at ${TEMPLATE_DIR}"

    # Add the generated graph files to staging area
    stage_files "${TEMPLATE_DIR}" "Issue Templates"
fi


# =============================================================================
# Issue Template Validation
# =============================================================================
echo "üîó Running issue template validation..."

# Path to the issue template validation script
ISSUE_TEMPLATE_VALIDATOR="scripts/hooks/validate_issue_templates.py"

run_validator "$ISSUE_TEMPLATE_VALIDATOR" "issue template validation" "$EDGE_ARGS"
if [[ $? -ne 0 ]]; then
    VALIDATION_FAILED=1
fi

echo  # Add blank line for readability

# =============================================================================
# Control Graph Generation (when components.yaml or controls.yaml changes)
# =============================================================================

# Only generate control graph in normal mode (not --force) when components.yaml or controls.yaml is staged
# Control graph depends on both files, so regenerate if either changes
if [[ $FORCE_VALIDATE -eq 0 ]] && git diff --cached --name-only | grep -q "risk-map/yaml/\(components\|controls\)\.yaml$"; then
    echo "üìä Components or controls changed - generating control-to-component graph..."

    # Ensure diagrams directory exists
    mkdir -p "${DIAGRAMS_DIR}"

    # Generate the control graph using the validator script
    if python3 "$EDGE_VALIDATOR" --to-controls-graph "${DIAGRAMS_DIR}/controls-graph.md" -m --quiet; then
        echo "   ‚úÖ Control graph generated at ${DIAGRAMS_DIR}/controls-graph.md"

        # Add the generated graph files to staging area
        stage_files "${DIAGRAMS_DIR}/controls-graph.md ${DIAGRAMS_DIR}/controls-graph.mermaid" "Controls Graph"
    else
        echo "   ‚ùå Control Graph generation failed"
        VALIDATION_FAILED=1
    fi
fi

echo  # Add blank line for readability

# =============================================================================
# Markdown Table Generation (when YAML files change)
# =============================================================================

# Only generate tables in normal mode when YAML files are staged
# Table generation logic:
#   - components.yaml ‚Üí components tables + controls-xref-components (regenerate)
#   - risks.yaml ‚Üí risks tables + controls-xref-risks (regenerate)
#   - controls.yaml ‚Üí all 4 controls tables (full, summary, xref-risks, xref-components)
if [[ $FORCE_VALIDATE -eq 0 ]]; then
    STAGED_FILES=$(git diff --cached --name-only)

    # Check if any YAML files requiring table generation are staged
    if echo "$STAGED_FILES" | grep -q "risk-map/yaml/\(components\|controls\|risks\)\.yaml$"; then
        echo "üìã YAML files changed - generating markdown tables..."

        TABLE_GENERATOR=".git/hooks/yaml_to_markdown.py"

        if [[ ! -f "$TABLE_GENERATOR" ]]; then
            echo "   ‚ö†Ô∏è  Warning: Table generator not found - skipping table generation"
        else
            # Ensure tables directory exists
            mkdir -p risk-map/tables

            # Components: generate component tables + xref-components (controls reference components)
            if echo "$STAGED_FILES" | grep -q "components.yaml$"; then
                echo "   üìê Generating tables for components..."
                if python3 "$TABLE_GENERATOR" components --all-formats --quiet; then
                    echo "   ‚úÖ Components tables generated (full, summary)"
                    stage_files "risk-map/tables/components-*.md" "Components tables" || true
                else
                    echo "   ‚ùå Components table generation failed"
                    VALIDATION_FAILED=1
                fi

                # Also regenerate xref-components since component data changed
                echo "   üìê Regenerating controls-xref-components (component data changed)..."
                if python3 "$TABLE_GENERATOR" controls --format xref-components --quiet; then
                    echo "   ‚úÖ Controls xref-components table regenerated"
                    stage_files "risk-map/tables/controls-xref-components.md" "Controls xref-components table" || true
                else
                    echo "   ‚ùå Controls xref-components regeneration failed"
                    VALIDATION_FAILED=1
                fi
            fi

            # Risks: generate risk tables + xref-risks (controls reference risks)
            if echo "$STAGED_FILES" | grep -q "risks.yaml$"; then
                echo "   üìê Generating tables for risks..."
                if python3 "$TABLE_GENERATOR" risks --all-formats --quiet; then
                    echo "   ‚úÖ Risks tables generated (full, summary)"
                    stage_files "risk-map/tables/risks-*.md" "Risks tables" || true
                else
                    echo "   ‚ùå Risks table generation failed"
                    VALIDATION_FAILED=1
                fi

                # Also regenerate xref-risks since risk data changed
                echo "   üìê Regenerating controls-xref-risks (risk data changed)..."
                if python3 "$TABLE_GENERATOR" controls --format xref-risks --quiet; then
                    echo "   ‚úÖ Controls xref-risks table regenerated"
                    stage_files "risk-map/tables/controls-xref-risks.md" "Controls xref-risks table" || true
                else
                    echo "   ‚ùå Controls xref-risks regeneration failed"
                    VALIDATION_FAILED=1
                fi
            fi

            # Controls: generate all 4 control formats (full, summary, xref-risks, xref-components)
            if echo "$STAGED_FILES" | grep -q "controls.yaml$"; then
                echo "   üìê Generating all tables for controls..."
                if python3 "$TABLE_GENERATOR" controls --all-formats --quiet; then
                    echo "   ‚úÖ All controls tables generated (4 formats)"
                    stage_files "risk-map/tables/controls-*.md" "Controls tables" || true
                else
                    echo "   ‚ùå Controls table generation failed"
                    VALIDATION_FAILED=1
                fi
            fi
        fi
    fi
fi

echo  # Add blank line for readability

# =============================================================================
# SVG Generation from Mermaid Files
# =============================================================================

# Generates SVG files from Mermaid diagrams in risk-map/diagrams/
# Args: none (uses global FORCE_VALIDATE flag)
# Behavior:
#   - Normal mode: generates SVGs only for staged .mmd/.mermaid files
#   - Force mode: generates SVGs for all .mmd/.mermaid files
generate_mermaid_svgs() {
    echo "üé® Running Mermaid SVG generation..."

    # Check prerequisites
    if [[ ! -d "./risk-map/svg" ]]; then
        echo "   ‚ö†Ô∏è  Directory ./risk-map/svg does not exist - skipping SVG generation"
        return 0
    fi

    if ! command -v npx &> /dev/null; then
        echo "   ‚ö†Ô∏è  npx command not found - skipping SVG generation"
        return 0
    fi

    if ! npx mmdc --version &> /dev/null; then
        echo "   ‚ö†Ô∏è  Mermaid CLI not available - skipping SVG generation"
        echo "   üí° Install with: npm install -g @mermaid-js/mermaid-cli"
        return 0
    fi

    echo "   ‚úÖ Prerequisites met - proceeding with SVG generation"

    local svg_failed=0
    local files_to_process=()
    local MERMAID_PATH="./risk-map/diagrams/"
    local SVGS_PATH="./risk-map/svg"
    local MERMAID_THEME="neutral"
    local MERMAID_BACKGROUND="transparent"

    # Create puppeteer config for stability
    local PUPPETEER_CONFIG_FILE=$(mktemp)

    # Build puppeteer config conditionally based on CHROMIUM_PATH
    if [[ -n "${CHROMIUM_PATH}" ]]; then
        echo '{
    "executablePath": "'"${CHROMIUM_PATH}"'",
    "args": ["--no-sandbox", "--disable-setuid-sandbox", "--disable-dev-shm-usage"]
}' > "${PUPPETEER_CONFIG_FILE}"
        echo "   Using Chromium at: ${CHROMIUM_PATH}"
    else
        echo '{
    "args": ["--no-sandbox", "--disable-setuid-sandbox", "--disable-dev-shm-usage"]
}' > "${PUPPETEER_CONFIG_FILE}"
        echo "   Using automatic Chrome detection"
    fi

    # Process only staged mermaid files (SVG generation doesn't run in force mode)
    echo "   Processing staged Mermaid files"
    while IFS= read -r -d '' file; do
        # Only include files that are in risk-map/diagrams/ directory
        if [[ "$file" == risk-map/diagrams/*.mmd ]] || [[ "$file" == risk-map/diagrams/*.mermaid ]]; then
            files_to_process+=("$file")
        fi
    done < <(git diff --cached --name-only -z | grep -z '\.\(mmd\|mermaid\)$')

    # Process files if any were found
    if [[ ${#files_to_process[@]} -gt 0 ]]; then
        echo "   Processing ${#files_to_process[@]} Mermaid file(s)..."

        for file in "${files_to_process[@]}"; do
            echo "   Converting $file..."

            # Generate SVG with same name but .svg extension
            local output_file="${SVGS_PATH}/$(basename "$file" | sed 's/\.[^.]*$/.svg/')"

            if npx mmdc -i "$file" -o "$output_file" -t "${MERMAID_THEME}" -b "${MERMAID_BACKGROUND}" -p "${PUPPETEER_CONFIG_FILE}"; then
                echo "   ‚úÖ Generated SVG: $(basename "$output_file")"
                # Add generated SVG to staging area (only in normal mode)
                if [[ $FORCE_VALIDATE -eq 0 ]]; then
                    stage_files "$output_file" "Generated SVG $(basename "$output_file")"
                fi
            else
                echo "   ‚ùå Failed to convert $(basename "$file")"
                svg_failed=1
            fi
        done

        if [[ $svg_failed -eq 0 ]]; then
            echo "   ‚úÖ All Mermaid files converted successfully"
        fi
    else
        echo "   No Mermaid files to process"
    fi

    # Clean up temp file
    rm -f "${PUPPETEER_CONFIG_FILE}"

    return $svg_failed
}

# =============================================================================
# Risk Graph Generation
# =============================================================================

# Only generate risk graph in normal mode (not --force) when components.yaml, controls.yaml or risks.yaml is staged
# Risk graph depends on all files, so regenerate if they change
if [[ $FORCE_VALIDATE -eq 0 ]] && git diff --cached --name-only | grep -q "risk-map/yaml/\(components\|controls\|risks\)\.yaml$"; then
    echo "üìä Components, controls, or risks changed - generating control-to-risk graph..."

    # Ensure diagrams directory exists
    mkdir -p "${DIAGRAMS_DIR}"

    # Generate the control graph using the validator script
    if python3 "$EDGE_VALIDATOR" --to-risk-graph "${DIAGRAMS_DIR}/controls-to-risk-graph.md" -m --quiet; then
        echo "   ‚úÖ Risk-to-Control graph generated at ${DIAGRAMS_DIR}/controls-to-risk-graph.md"

        # Add the generated graph files to staging area
        stage_files "${DIAGRAMS_DIR}/controls-to-risk-graph.md ${DIAGRAMS_DIR}/controls-to-risk-graph.mermaid" "Risk-to-Control Graph"
    else
        echo "   ‚ùå Risk-to-Controls Graph generation failed"
        VALIDATION_FAILED=1
    fi
fi

echo  # Add blank line for readability

# Only run SVG generation when mermaid files change and not in force mode
if [[ $FORCE_VALIDATE -eq 0 ]] && git diff --cached --name-only | grep -q '\.\(mmd\|mermaid\)$'; then
    generate_mermaid_svgs
    if [[ $? -ne 0 ]]; then
        VALIDATION_FAILED=1
    fi
else
    echo "üé® No Mermaid files changed - skipping SVG generation"
fi

echo  # Add blank line for readability

# Exit with error if any validation failed
if [[ $VALIDATION_FAILED -ne 0 ]]; then
    exit 1
fi 

# =============================================================================
# Success Summary
# =============================================================================
echo "üéâ All pre-commit validations passed!"
echo "   ‚úÖ YAML schema validation"
echo "   ‚úÖ Prettier formatting"
echo "   ‚úÖ Ruff linting"
echo "   ‚úÖ Component edge validation"
echo "   ‚úÖ Control-to-risk reference validation"
echo "   ‚úÖ Framework reference validation"
echo "   ‚úÖ Issue template validation"
echo "   ‚úÖ Mermaid SVG generation"

# Check if component graph was generated and add to summary
if [[ $FORCE_VALIDATE -eq 0 ]] && git diff --cached --name-only | grep -q "risk-map/yaml/components\.yaml$"; then
    echo "   üìä Component Graph generated and staged"
fi

# Check if control graph was generated and add to summary
if [[ $FORCE_VALIDATE -eq 0 ]] && git diff --cached --name-only | grep -q "risk-map/yaml/\(components\|controls\)\.yaml$"; then
    echo "   üìä Control Graph generated and staged"
fi

# Check if risk graph was generated and add to summary
if [[ $FORCE_VALIDATE -eq 0 ]] && git diff --cached --name-only | grep -q "risk-map/yaml/\(components\|controls\|risks\)\.yaml$"; then
    echo "   üìä Risk Graph generated and staged"
fi

# Check if SVGs were generated and add to summary
if [[ $FORCE_VALIDATE -eq 0 ]] && git diff --cached --name-only | grep -q '\.svg$'; then
    echo "   üé® SVG files generated and staged"
fi

# Check if SVGs were generated and add to summary
if [[ $FORCE_VALIDATE -eq 0 ]] && git diff --cached --name-only | grep -q '.github/ISSUE_TEMPLATE'; then
    echo "   ‚úÖ Github Issue Template files generated and staged"
fi

echo "Ready to commit! üöÄ"